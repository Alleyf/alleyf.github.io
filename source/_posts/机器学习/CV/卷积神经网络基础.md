---
title: 卷积神经网络基础  
date: 2023-03-17 19:10:27  
tags: [CNN]  
sticky: 60
excerpt: some konwledge about CNN.
---
# 卷积
## 步幅（stride）
卷积核运算过程中==移动的距离大小==。
卷积后的输出尺寸计算公式如下：
$$ H_{out}= \frac{H+2p_{h}-k_{h}}{s_{h}}+1 $$
$$ W_{out}= \frac{W+2p_{w}-k_{w}}{s_{w}}+1 $$
> 其中$p_h$和$p_w$分别为高度和宽度**填充**，$k_h$和$k_w$分别为卷积核的高宽**大小**，$s_h$和$s_w$分别为高度和宽度**步幅**。
## 批量卷积
对RGB三通道，同时输入一个批次（batch）张图片做卷积运算，每张图像卷积后通道叠在一起（不是叠加），如下图所示：
![image.png](https://raw.githubusercontent.com/Alleyf/PictureMap/main/web_icons/202303201948212.png)
---
## 感受野
>感受野是指输出特征图上的像素点所能感受到的输入数据的范围。

从下图可以看出感受野的大小：
![image.png](https://s2.loli.net/2023/03/20/dC7PyWFI5ZmHhxr.png)
`网络越深，越深层特征图的感受野越大，主要从输入的主对角线反映。`
## Paddle API卷积
![image.png](https://alist.fcsy.fit/d/mobilepan/PicoImages/20230320203438.png)
---
### 案例1-边缘检测二值图
>检测图像黑白分界线。

![image.png](https://alist.fcsy.fit/d/mobilepan/PicoImages/20230320205235.png)

```python
with fluid. dygraph. guard():
#创建初始化权重参数w
w = np.array([1, 0, -1], dtype= 'float32')
#将权重参数调整成维度为[cout, cin, kh, kw]的四维张里
w = w.reshape([1, 1, 1, 3])
#创建卷积算子，设置输出通道数，卷积核大小，和初始化权重参数
# filter_size = [1, 3]表示kh = 1, kw=3
#创建卷积算子的时候，通过参数属性param_ attr, 指定参数初始化方式
#这里的初始化方式时，从numpy. ndarray初始化卷积参数
#num_channels:输入通道数；num_filters：输出通道数；filter_size：卷积核高宽，param_attr：初始化参数
conv = Conv2D(num_channels=1, num_filters=1, filter_size=[1,3],param_attr=fluid.ParamAttr(
initializer=NumpyArrayInitializer(value=w)))
#创建输入图片，图片左边的像素点取值为1，右边的像素点取值为0
img = np.ones([50,50], dtype='f1oat32')
img[:, 30:] = 0.
#将图片形状调整为[N(bach_size), C（chanel）, H, W]的形式
x = img.reshape([1,1,50,50])
#将numpy.ndarray转化成paddle中的tensor
x = fluid.dygraph.to_variable(x)
#使用卷积算子作用在输入图片上
y = conv(x)
#将输出tensor转化为numpy.ndarray
out = y.numpy()
```
>查看卷积层参数:`conv.parameters()`
>![image.png](https://alist.fcsy.fit/d/mobilepan/PicoImages/20230320205955.png)
---
### 案例2-边缘检测RGB彩图
>`图片初始读入的形状为[H,W,C](垂直像素，水平像素，通道数)，需要调整为[N,C,H,W]格式。`
>卷积核：
>![image.png](https://alist.fcsy.fit/d/mobilepan/PicoImages/20230320213046.png)

```python
img = Image.open("./work/ images/section1000000098520. jpg')
with fluid.dygraph.guard():
#设置卷积核参数
w = np.array([[-1,-1,-1], [-1,8,-1], [-1,-1,-1]], dtype= 'float32')/8
w = w.reshape([1, 1, 3, 3])
#由于输入通道数是3，将卷积核的形状从[1,1,3,3]调整为[1p3,p,3]
w = np.repeat(w,3，axis=1)、
#创建卷积算子，输出通道数为1，卷积核大小为3x3，
#并使用上面的设置好的数值作为卷积核权重的初始化参数
conv = Conv2D(num_channels=3, num_filters=1, filter_size=[3,3],param_attr=fluid.ParamAttr(initializer=NumpyArrayInitializer(value=w)))
				  #将读入的图片转化为float32类型的numpy.ndarray
x = np.array(img).astype('float32')
#图片读入成ndarry时，形状是[H, W, C]，
#将通道这一维度调整到最前面
x = np.transpose(x, (2,0,1))
#将数据形状调整为[N, C, H, W]格式
x = x.reshape(1, 3, img.height, img.width)
x = fluid.dygraph.to_variable(x)#变为张量格式
y = conv(x)
out = y.numpy()#张量转numpy数组
```
---
### 案例3-均值模糊
>卷积核：
>![image.png](https://alist.fcsy.fit/d/mobilepan/PicoImages/20230320213328.png)
>效果对比：
>![image.png](https://alist.fcsy.fit/d/mobilepan/PicoImages/20230320213358.png)


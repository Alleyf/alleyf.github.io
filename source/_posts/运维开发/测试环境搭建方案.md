---
title: ETMS测试环境搭建方案
date: 2025-03-25 10:32:59
tags:
  - K8s
  - DevOps
sticky: 20
excerpt: 
author: fcs
index_img: https://picsum.photos/800/250
lang: zh-CN
number headings:
---

#### 一、环境隔离策略

1. **数据库（PolarDB MySQL）**
   - **隔离方式**：创建独立的测试数据库实例（如 `etms_test`），与生产数据库（`etms_prod`）物理隔离。
   - **资源配置**：
     - 存储容量：根据测试需求动态调整，初期分配与生产环境相同容量。
     - 规格配置：复用生产环境规格（如 CPU/内存），若测试负载过高可升配。

2. **缓存（Redis）**
   - **隔离方式**：使用不同的数据库编号（如 `db0` 为生产，`db1` 为测试）。
   - **扩展性**：若测试数据量激增，可增加 Redis 分片。

3. **配置中心（Nacos）**
   - **隔离方式**：通过命名空间（Namespace）隔离环境（如 `prod-namespace` 和 `test-namespace`）。
   - **配置管理**：所有环境的数据库地址、服务参数等统一存储在 Nacos，通过命名空间动态切换。

4. **容器服务（ACK）**
   - **隔离方式**：创建独立的命名空间（如 `etms-test`），复用生产环境的部署流程（YAML 配置）。
   - **资源扩展**：通过节点自动伸缩动态控制 ECS 节点数量实现水平扩容或缩容，应用无需调整即可自动负载均衡。

5. **负载均衡**
   - **隔离方式**：使用不同三级域名区分环境（如 `jptest.liyunol.com` 和 `jp.liyunol.com`）。

---

#### 二、资源评估与扩容策略

| 组件          | 当前资源评估                | 扩容方案                    |
| ----------- | --------------------- | ----------------------- |
| **PolarDB** | 支持多库隔离，存储可动态扩容        | 存储不足时扩容磁盘，性能不足时升配 CPU/内存 |
| **Redis**   | 单实例多库模式满足初期需求         | 升配或增加分片数量               |
| **Nacos**   | 单节点可支撑测试环境，性能压力较低     | 必要时升配或升级为集群模式           |
| **ACK**     | 初始节点数与生产环境一致，支持弹性自动伸缩 | 按需增加 ECS 节点，自动负载均衡        |

#### 三、实施步骤

1. **资源准备**
   - 创建 PolarDB 测试数据库、Redis 测试库、Nacos 测试命名空间、ACK 测试命名空间。
   - 配置负载均衡域名解析（`jptest.liyunol.com`）。

2. **配置迁移**
   - 从生产 Nacos 导出配置，导入测试命名空间并修改数据库连接参数。

3. **数据迁移**
   - 使用数据迁移工具（如 Navicat）将生产数据迁移到测试环境。

4. **部署测试环境**
   - 编写 Gitlab 测试环境流水线打包、构建镜像，并在 ACK 测试命名空间部署服务。
   - 验证服务连通性及配置加载是否正确。

5. **监控与调优**
   - 监控各组件资源使用率（如 PolarDB 存储、ACK 节点负载）。
   - 按需触发扩容策略（如 ACK 节点扩容、PolarDB 存储扩容）。

---

#### 四、功能发布流程

1. **代码提交**
   - 开发人员提交代码到 Gitlab 测试分支。
   - 触发 Gitlab 流水线，自动构建并部署测试环境。
   - 测试人员通过负载均衡域名访问测试环境，进行功能测试。

1. **功能验收**
   - 测试人员完成功能验收，确认无问题后由开发人员合并代码到主分支。
   - 触发 Gitlab 流水线，自动构建并部署生产环境。
   - 生产环境上线，用户访问正式环境。

1. **回滚策略**
   - 若测试或正式环境出现问题，可回滚到上一个版本。
   - 回滚操作需谨慎，需通知相关团队成员。

![](https://raw.githubusercontent.com/Alleyf/PictureMap/main/blog/20250325114618498.png)

%%
graph TD
    A[本地开发测试无误后代码提交到测试分支] --> B[触发 GitLab 流水线]
    B --> C[自动构建并部署测试环境]
    C --> D[测试人员（北师大和测试团队）通过测试域名访问测试环境]
    D --> E[功能验证测试]
    E --> F{测试通过?}
    F -->|是| G[合并代码到主分支]
    G --> H[触发 GitLab 流水线]
    H --> I[自动构建并部署生产环境]
    I --> J[用户访问正式环境]
    F -->|否| K[回滚到上一版本]
    K --> L[通知相关团队成员修复]
    J --> M{生产环境异常?}
    M -->|是| K
    M -->|否| N[发布完成]
%%

---

#### 五、优势与风险

- **优势**：
  - 环境隔离彻底，避免数据污染。
  - 配置集中管理，提升维护效率。
  - 弹性扩展能力强，资源利用率高。
- **风险**：
  - 测试环境性能不足时可能影响生产（需严格监控资源配额）。
  - Redis 多库模式下需注意键名冲突（建议增加前缀规范）。
- **结论**：本方案通过命名空间、独立数据库、三级域名等手段实现多环境隔离，结合 Nacos 动态配置和 ACK 弹性扩容，可快速搭建测试环境。
- **完成时间预估**：2025-03-30（本周末）

---

#### 预算评估

ACK节点费用：
![|575](https://raw.githubusercontent.com/Alleyf/PictureMap/main/blog/20250325202907261.png)

数据库存储费用：
![|575](https://raw.githubusercontent.com/Alleyf/PictureMap/main/blog/20250325203547241.png)

|        组件        |                         资源配置                         |      预算（元）       |
| :--------------: | :--------------------------------------------------: | :--------------: |
|   **ACK集群节点**    | 规格配置：ecs.u1-c1m4.xlarge-4核16G(+3~4个，25元/pernode/day) | +2325或3100/month |
| **PolarDBMySQL** |           容量扩展（150GB-->200GB:+50GB，1元/GB）            |    +50/month     |
|      **总计**      |                                                      |    2375~3150     |

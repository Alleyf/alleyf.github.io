---
title: 运维排忧解难
date: 2024-06-28 00:37:11
tags:
  - 运维
  - DevOps
sticky: 80
excerpt: 运维排错解决问题的必查手册
author: fcs
index_img: https://picsum.photos/800/250
lang: zh-CN
number headings: auto, first-level 1, max 5, start-at 1, 1.1
---

![](https://picsum.photos/800/250)

# 1 常用指令

> [!NOTE] 符号说明
> 指令中小括号`()`内为**选填项**，`<>`为**填充项**（根据实际变量进行填充）。

## 1.1 Linux 指令

[各种环境配置](source/_posts/运维开发/各种环境配置.md)

### 1.1.1 Ssh连接

-p 指定端口，默认不带则为22端口

```sh
ssh -p <port> <username>@<ip/hostname>
```

### 1.1.2 文件传输

> 通过ssh协议用于在本地计算机和远程计算机之间安全地复制文件

1. 本地到远程

```sh
scp (-p <port>) </path/to/local/file> <username>@<remote_host/host_name>:</path/to/remote/directory>
```

2. 远程到本地

```sh
scp (-p <port>) <username>@<remote_host/host_name>: </path/to/remote/directory> </path/to/local/file> 
```

### 1.1.3 查看资源

查看所有资源占用情况，降序排列，`top` 默认会实时更新显示的信息，通常每秒刷新一次。

```sh
top 
```

1. **排序**：
    - 按 CPU 使用率排序：按 `P` 键。
    - 按内存使用率排序：按 `M` 键。
    - 按执行时间排序：按 `T` 键。
2. **搜索进程**：
    - 输入 `u` 键，然后输入用户名，可以显示该用户的所有进程。
    - 输入 `p` 键，然后输入进程ID（PID），可以快速定位到特定进程。
3. **过滤进程**：
    - 输入 `U` 键，然后输入用户名，可以过滤显示该用户的进程。
    - 输入 `P` 键，然后输入进程ID（PID），可以过滤显示该PID的进程。
4. **杀死进程**：
    - 输入 `k` 键，然后输入进程ID和要发送的信号（默认是SIGTERM，即15），可以杀死进程。

### 1.1.4 查看进程

`ps` 命令在 Unix-like 系统中用于显示当前进程的状态。

```sh
ps
```

1. 参数说明
	- `USER`：进程所有者的用户名。
	- `PID`：进程的ID。
	- `%CPU`：进程占用的CPU百分比。
	- `%MEM`：进程占用的内存百分比。
	- `VSZ`：虚拟内存大小（Virtual Size）。
	- `RSS`：实际内存大小（Resident Set Size）。
	- `TTY`：进程终端类型。
	- `STAT`：进程状态。
	- `START`：进程启动时间。
	- `TIME`：进程占用CPU的时间。
	- `COMMAND`：启动进程的命令。

2. 常见组合
	- ps aux (--sort=-%mem/cpu)： 显示所有进程(按照内存/CPU使用率降序排列进程)
	- ps -ef：显示所有进程的完整信息。
	- ps -p PID：显示特定进程的详细信息。

### 1.1.5 查看编辑文件

#### 1.1.5.1 查看目录

列出当前目录下的文件和文件夹

```sh
ls
```

1. 常见搭配
	- ls -lh：组合使用 `-l` 和 `-h` 选项，以易读的格式显示文件大小。
	- ls -l：以长列表格式显示文件详细信息，包括权限、所有者、大小和最后修改时间。
	- ls -lt：以修改时间排序，最新修改的文件排在最前面。
	- ls -lS：以文件大小排序。
	- ls -a：显示所有文件，包括以点（`.`）开头的隐藏文件。
	- ls -R：递归地列出所有子目录的内容。
	- ls -F：在每个文件名后添加一个字符以指示文件类型，例如，`/` 表示目录，`*` 表示可执行文件。
	- ls -o：显示文件所有者和组，但不显示组名。
	- ls --color：使用颜色来区分不同类型的文件。
	- ls \*.txt：列出当前目录下所有的 `.txt` 文件。

1. 参数解释：`drwxr-xr-x 10 root root 4.0K Feb 22 21:41 clash`
	- d：目录/文件
	- rwx：文件所有者的权限，`r` 代表可读（read），`w` 代表可写（write），`x` 代表可执行（execute）
	- r-x：文件所有者同组的用户（group）的权限，可读可执行但不可写
	- r-x：其他用户（others）的权限，可读可执行但不可写
	- 10：硬链接指向这个目录的个数，目录至少为2（一个是 `.` 表示当前目录，另一个是 `..` 表示父目录），加上目录下文件和子目录的数量。
	- root root：文件所有者和组的名称。
	- 4.0K：目录占用空间大小（不包括子文件和子目录）。
	- Feb 22 21:41：目录最后修改的日期和时间。
	- clash：目录名称。

#### 1.1.5.2 查看内容

查看文件内容，打印在控制台

```sh
cat <fileName>
```

#### 1.1.5.3 新建文件

新增一个文件，或写入内容到文件中

```sh
cat > <file.txt>
echo <content> > <file.txt>
touch <file.txt>
```

#### 1.1.5.4 编辑内容

使用Vim编辑器编辑文件

```sh
vi(m) <fileName>
```

1. 常见操作：
	- i：进入插入写模式
	- esc：退出当前模式
	- ：指令模式
	- :q：直接退出
	- :wq：保存退出

## 1.2 K8s 和 Docker相关指令

### 1.2.1 K8s

#### 1.2.1.1 集群

获取 prod 集群中所有节点信息

```sh
# 正式集群
kube-prod get nodes
# 测试集群
kube-test get nodes
```

#### 1.2.1.2 节点

获取指定命名空间下的所有 pod

```sh
kube-prod get pod -n <namespace>
```

获取指定 pod 的详情（`可根据 event 排查 pod 的错误信息`）

```sh
kube-prod describe pod <pod-name> -n <namespace>
```

### 1.2.2 Docker

#### 1.2.2.1 保存镜像

将指定本地镜像保存为tar压缩包

```sh
docker save -o <image.tar> <image>
```

#### 1.2.2.2 加载镜像

根据指定镜像压缩包加载镜像到本地

```sh
docker load -i <image.tar>
```

# 2 常见问题

> [!warning] Tips
> 1. **重启（物理机、虚拟机、服务、pod等）** 可能是`最直接常见的办法`，但`不是最有效`的办法，具体问题具体分析，重在**根据问题逐步搜索的排查思路，自顶向下排查，自底向上解决**。
> 2. *遇到问题不要慌，众里寻它先百度，属是不行再问路，先思考后动脑，多学多看多实践，能力日益节节高*。

## 2.1 镜像无法拉取

1. 原因：由于国内防火墙导致国外官方镜像仓库被墙无法拉取镜像
2. 办法：
   - 出国旅游：windosw开启魔法拉取镜像后通过docker save和load转移镜像，并push到本地私有镜像仓库留存。
   - 取而代之：寻找国内镜像源仓库，直接拉取国内镜像仓库的镜像到本地，并推送到本地私有仓库留存。（国内镜像仓库不稳定，可能会清除镜像）

## 2.2 内存/硬盘满载/溢出

1. 原因：随着时间的累积和负载变化，内存或硬盘资源可能会不够，虚拟机负载过大，无法提供正常响应。
2. 办法：
   - 内存：清理无用进程（kill），重启虚拟机（reboot），扩容内存（vcenter扩大虚拟机内存）
   - 硬盘：查看磁盘分区和挂载情况（df -h），清理无用文件（rm -rf），转移文件（mv），硬盘扩容（分配更多分布式存储容量，添加一块磁盘并进行磁盘分区）
"use strict";const merge=require("deepmerge"),JSON5=require("json5"),config_default_source=require("../config/config_default").config_default;let config_default=require("../config/config_default").config_default;class Config{constructor(e){this.hexo=e,this.root=e.config.root||"/",this.public_dir=e.config.public_dir||"public",e.config.mmedia&&this._parse(this.clone(e.config.mmedia))}clone(e){return JSON5.parse(JSON5.stringify(e))}_parse(e){config_default=merge(config_default_source,e)}}const utils=require("utility");module.exports=function(e,t,s){switch(t[0]){case"audio":return new Audio0(e,t,s).generate();case"video":return new Video(e,t,s).generate();case"meting":return new Meting(e,t,s).generate();case"aplayer":return new Aplayer(e,t,s).generate();case"dplayer":return new Dplayer(e,t,s).generate();case"bilibili":return new Bilibili(e,t,s).generate();case"xigua":return new Xigua(e,t,s).generate();case"artplayer":return new ArtPlayer(e,t,s).generate()}};class BaseConfig{}class BaseMmedia{constructor(e,t,s){this.contents=JSON5.parse("{}"),this.hexo=e,this.args=t,this.config=new Config(e),s&&(this.contents=JSON5.parse(s))}generate(){return""}extractOption(e){var t=e.indexOf(":"),s=e.indexOf("=");return-1==t?[e.slice(0,e.indexOf("=")),e.slice(e.indexOf("=")+1)]:-1==s||t<s?[e.slice(0,e.indexOf(":")),e.slice(e.indexOf(":")+1)]:s<t?[e.slice(0,e.indexOf("=")),e.slice(e.indexOf("=")+1)]:void 0}}class BaseTag{constructor(e,t,s){this.result="",this.mmedia_id=utils.randomString(16,"qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"),this.contents=merge(t.data.contents,s),this.tag_id=`mmedia-${this.mmedia_id}`,this.hexo=e,this.js=(e,t=!0)=>{this.result+=t?`<script src="${e}"></script>`:`<script>${e}</script>`},this.css=(e,t=!0)=>{this.result+=t?`<link rel="stylesheet" href="${e}">`:`<style>${e}</style>`}}parse(e){let t="";for(var s in e)""!=s&&null!=s&&(""!=e[s]&&null!=e[s]?"true"===e[s]||"false"===e[s]||Number(e[s])+""!="NaN"?t+=`${s}=${e[s]} `:t+=`${s}="${e[s]}" `:t+=`${s} `);return t}injector(e,t,s){this.hexo.extend.injector.register(e,t,s)}}class Aplayer extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.aplayer_config=new AplayerConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.aplayer_config.data[e[0]]=e[1])}),new AplayerTag(this.hexo,this.aplayer_config,this.contents).generate()}}class AplayerConfig extends BaseConfig{constructor(){super(...arguments),this.aplayer_css=config_default.aplayer.css,this.aplayer_js=config_default.aplayer.js,this.data=config_default.aplayer.default||{}}}class AplayerTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t,this.contents=s}a_parse(e){let t={},s={};for(var a in e)if(""!=a&&null!=a)switch(a){case"name":s.name=e[a];break;case"artist":s.artist=e[a];break;case"url":s.url=e[a];break;case"cover":s.cover=e[a];break;case"lrc":s.lrc=e[a];break;case"theme":s.theme=e[a];break;case"type":s.type=e[a];break;case"autoplay":t.autoplay="false"!=e[a];break;case"loop":t.loop=e[a];break;case"order":t.order=e[a];break;case"volume":t.volume=Number(e[a]);break;case"tlistMaxHeight":t.listMaxHeight=Number(e[a])}return t.audio=[s],t}generate(){this.result+=`<div id="${this.tag_id}"></div>`;var e=this.config.data,e=utils.assign({},[e.contents,this.a_parse(e),this.contents]),e=`var ${this.mmedia_id}_options = JSON.parse('${JSON.stringify(e).replace(/"([^"]*)"/g,'\\"$1\\"')}');
    ${this.mmedia_id}_options.container = document.getElementById("${this.tag_id}");`;return e+=`HEXO_MMEDIA_DATA.css.push("${this.config.aplayer_css}");`,e+=`HEXO_MMEDIA_DATA.js.push("${this.config.aplayer_js}");`,e+=`HEXO_MMEDIA_DATA.aplayerData.push(${this.mmedia_id}_options);`,this.result+=`<script> ${e} </script>`,this.result}}class Audio0 extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.audio_config=new AudioConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.audio_config.data[e[0]]=e[1])}),new AudioTag(this.hexo,this.audio_config,this.contents).generate()}}class AudioConfig extends BaseConfig{constructor(){super(...arguments),this.data=config_default.audio.default||{}}}class AudioTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t}generate(){var e=merge(this.config.data,this.contents),e=`<audio id="${this.tag_id}" ${this.parse(e)}></audio>`;return this.result+=e,this.result}}class ArtPlayer extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.artplayer_config=new ArtPlayerConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.artplayer_config.data[e[0]]=e[1])}),new ArtPlayerTag(this.hexo,this.artplayer_config,this.contents).generate()}}class ArtPlayerConfig extends BaseConfig{constructor(){super(...arguments),this.artplayer_js=config_default.artplayer.js,this.hls_js=config_default.artplayer.hls_js,this.dash_js=config_default.artplayer.dash_js,this.shaka_dash_js=config_default.artplayer.shaka_dash_js,this.flv_js=config_default.artplayer.flv_js,this.webtorrent_js=config_default.artplayer.webtorrent_js,this.data=config_default.artplayer.default||{}}}class ArtPlayerTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t}art_parse(e){let t={};for(var s in e)if(""!=s&&null!=s)switch(s){case"url":t.url=e[s];break;case"type":t.type=e[s];break;case"title":t.title=e[s];break;case"poster":t.poster=e[s];break;case"autoplay":t.autoplay="false"!=e[s];break;case"loop":t.loop="false"!=e[s];break;case"volume":t.volume=Number(e[s]);break;case"style":t.style=e[s]}return t}art_js(e){let t=[];for(var s in e)if(""!=s&&null!=s)switch(s){case"hls":t.push(e[s]||this.config.hls_js);break;case"dash":t.push(e[s]||this.config.dash_js);break;case"shaka_dash":t.push(e[s]||this.config.shaka_dash_js);break;case"flv":t.push(e[s]||this.config.flv_js);break;case"webtorrent":t.push(e[s]||this.config.webtorrent_js)}return t}generate(){var e=this.config.data,t=utils.assign(this.art_parse(e),this.contents);this.result+=`<div id="${this.tag_id}" style="${t.style}"></div>`;let s=`var ${this.mmedia_id}_options = JSON.parse('${JSON.stringify(t).replace(/"([^"]*)"/g,'\\"$1\\"')}'); ${this.mmedia_id}_options.container = "#${this.tag_id}"; `;return this.art_js(e).forEach(e=>{e&&""!=e&&null!=e&&(s+=`HEXO_MMEDIA_DATA.js.push("${e}");`)}),s+=`HEXO_MMEDIA_DATA.js.push("${this.config.artplayer_js}");`,s+=`HEXO_MMEDIA_DATA.artPlayerData.push(${this.mmedia_id}_options);`,this.result+=`<script> ${s} </script>`,this.result}}class Meting extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.meting_config=new MetingConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.meting_config.data[e[0]]=e[1])}),new MetingTag(this.hexo,this.meting_config,this.contents).generate()}}class MetingConfig extends BaseConfig{constructor(){super(...arguments),this.aplayer_css=config_default.aplayer.css,this.aplayer_js=config_default.aplayer.js,this.meting_js=config_default.meting.js,this.meting_api=config_default.meting.api,this.data=config_default.meting.default||{}}}class MetingTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t}generate(){this.result+=`<div id="${this.tag_id}"></div>`,this.config.meting_api&&""!=this.config.meting_api&&null!=this.config.meting_api&&(e=`var meting_api='${this.config.meting_api}?server=:server&type=:type&id=:id&auth=:auth&r=:r';`,this.result+=`<script> ${e} </script>`);var e={id:this.tag_id,data:merge(this.config.data,this.contents)},e=`var ${this.mmedia_id}_options = JSON.parse('${JSON.stringify(e).replace(/"([^"]*)"/g,'\\"$1\\"')}'); `;return e+=`HEXO_MMEDIA_DATA.css.push("${this.config.aplayer_css}");`,e+=`HEXO_MMEDIA_DATA.js.push("${this.config.aplayer_js}");`,e+=`HEXO_MMEDIA_DATA.js.push("${this.config.meting_js}");`,e+=`HEXO_MMEDIA_DATA.metingData.push(${this.mmedia_id}_options);`,this.result+=`<script> ${e} </script>`,this.result}}class Dplayer extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.dplayer_config=new DplayerConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.dplayer_config.data[e[0]]=e[1])}),new DplayerTag(this.hexo,this.dplayer_config,this.contents).generate()}}class DplayerConfig extends BaseConfig{constructor(){super(...arguments),this.dplayer_js=config_default.dplayer.js,this.hls_js=config_default.dplayer.hls_js,this.dash_js=config_default.dplayer.dash_js,this.shaka_dash_js=config_default.dplayer.shaka_dash_js,this.flv_js=config_default.dplayer.flv_js,this.webtorrent_js=config_default.dplayer.webtorrent_js,this.data=config_default.dplayer.default||{}}}class DplayerTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t}d_parse(e){let t={video:{}};for(var s in e)if(""!=s&&null!=s)switch(s){case"url":t.video.url=e[s];break;case"pic":t.video.pic=e[s];break;case"thumbnails":t.video.thumbnails=e[s];break;case"type":t.video.type=e[s];break;case"autoplay":t.autoplay="false"!=e[s];break;case"loop":t.loop="false"!=e[s];break;case"logo":t.logo=e[s];break;case"volume":t.volume=Number(e[s]);break;case"screenshot":t.listMaxHeight="false"!=e[s];break;case"id":t.danmaku||(t.danmaku={}),t.danmaku.id=e[s];case"api":t.danmaku||(t.danmaku={}),t.danmaku.api=e[s]}return t}d_js(e){let t=[];for(var s in e)if(""!=s&&null!=s)switch(s){case"hls":t.push(e[s]||this.config.hls_js);break;case"dash":t.push(e[s]||this.config.dash_js);break;case"shaka_dash":t.push(e[s]||this.config.shaka_dash_js);break;case"flv":t.push(e[s]||this.config.flv_js);break;case"webtorrent":t.push(e[s]||this.config.webtorrent_js)}return t}generate(){this.result+=`<script src="${this.config.dplayer_js}"></script>`;var e=this.config.data,t=utils.assign(this.d_parse(e),this.contents);this.result+=`<div id="${this.tag_id}"></div>`;let s=`var ${this.mmedia_id}_options = JSON.parse('${JSON.stringify(t).replace(/"([^"]*)"/g,'\\"$1\\"')}'); ${this.mmedia_id}_options.container = document.getElementById("${this.tag_id}"); `;return this.d_js(e).forEach(e=>{e&&""!=e&&null!=e&&(s+=`HEXO_MMEDIA_DATA.js.push("${e}");`)}),s+=`HEXO_MMEDIA_DATA.js.push("${this.config.dplayer_js}");`,s+=`HEXO_MMEDIA_DATA.dplayerData.push(${this.mmedia_id}_options);`,this.result+=`<script> ${s} </script>`,this.result}}class Video extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.video_config=new VideoConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.video_config.data[e[0]]=e[1])}),new VideoTag(this.hexo,this.video_config,this.contents).generate()}}class VideoConfig extends BaseConfig{constructor(){super(...arguments),this.data=config_default.video.default||{}}}class VideoTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t}generate(){var e=merge(this.config.data,this.contents),e=`<video id="${this.tag_id}" ${this.parse(e)}></video>`;return this.result+=e,this.result}}class Xigua extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.xigua_config=new XiguaConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.xigua_config.data[e[0]]=e[1])}),new XiguaTag(this.hexo,this.xigua_config,this.contents).generate()}}class XiguaConfig extends BaseConfig{constructor(){super(...arguments),this.data=config_default.xigua.default||{}}}class XiguaTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t}x_parse(e){let t={};for(var s in e)if(""!=s&&null!=s)switch(s){case"xid":t.xid=e[s];break;case"id":t.id=e[s];break;case"autoplay":t.autoplay=e[s];break;case"startTime":t.danmaku=e[s];break;case"allowfullscreen":t.allowfullscreen=e[s];break;case"sandbox":t.sandbox=e[s];break;case"width":t.width=e[s];break;case"max_width":t.max_width=e[s];break;case"margin":t.margin=e[s]}return t}generate(){var e=merge(this.config.data,this.contents),e=this.x_parse(e);this.result+=`<style>.xgplayer{width: ${e.width}; max-width: ${e.max_width}; margin: ${e.margin}}</style>`,this.result+=`<div class="xgplayer"><iframe class="xgplayer" id="${this.tag_id}" src="https://www.ixigua.com/iframe/${e.xid}?${e.id?"id="+e.id+"&":""}autoplay=${"true"==e.autoplay?1:0}&startTime=${e.startTime}" allowfullscreen="${"allowfullscreen"==e.allowfullscreen||"true"==e.allowfullscreen?"allowfullscreen":"no"}" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="${e.sandbox}"></iframe></div>`;e=`document.getElementById("${this.tag_id}").style.height=document.getElementById("${this.tag_id}").scrollWidth\*0.7+"px";
    window.onresize = function(){
      document.getElementById("${this.tag_id}").style.height=document.getElementById("${this.tag_id}").scrollWidth\*0.7+"px";
    };`;return this.result+=`<script> ${e} </script>`,this.result}}class Bilibili extends BaseMmedia{constructor(e,t,s){super(e,t,s),this.bilibili_config=new BilibiliConfig}generate(){return this.args.forEach(e=>{e=this.extractOption(e);e&&(this.bilibili_config.data[e[0]]=e[1])}),new BilibiliTag(this.hexo,this.bilibili_config,this.contents).generate()}}class BilibiliConfig extends BaseConfig{constructor(){super(...arguments),this.data=config_default.bilibili.default||{}}}class BilibiliTag extends BaseTag{constructor(e,t,s){super(e,t,s),this.config=t}b_parse(e){let t={};for(var s in e)if(""!=s&&null!=s)switch(s){case"aid":t.aid=e[s];break;case"bvid":t.bvid=e[s];break;case"page":t.page=e[s];break;case"danmaku":t.danmaku=e[s];break;case"allowfullscreen":t.allowfullscreen=e[s];break;case"sandbox":t.sandbox=e[s];break;case"width":t.width=e[s];break;case"max_width":t.max_width=e[s];break;case"margin":t.margin=e[s];break;case"autoplay":t.autoplay=e[s]}return t}generate(){var e=merge(this.config.data,this.contents),e=this.b_parse(e);this.result+=`<style>.bbplayer{width: ${e.width}; max-width: ${e.max_width}; margin: ${e.margin}}</style>`,this.result+=`<div class="bbplayer"><iframe class="bbplayer" id="${this.tag_id}" src="https://player.bilibili.com/player.html?${e.bvid?"bvid="+e.bvid:"aid="+e.aid}&page=${e.page}&high_quality=1&danmaku=${e.danmaku}&autoplay=${"false"==e.autoplay||"0"==e.autoplay?0:1}" allowfullscreen="${"allowfullscreen"==e.allowfullscreen||"true"==e.allowfullscreen?"allowfullscreen":"no"}" scrolling="no" border="0" frameborder="0" framespacing="0" sandbox="${e.sandbox}"></iframe></div>`;e=`document.getElementById("${this.tag_id}").style.height=document.getElementById("${this.tag_id}").scrollWidth\*0.76+"px";
    window.onresize = function(){
      document.getElementById("${this.tag_id}").style.height=document.getElementById("${this.tag_id}").scrollWidth\*0.76+"px";
    };`;return this.result+=`<script> ${e} </script>`,this.result}}